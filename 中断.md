# 中断

## 概念

中断发生：当CPU处理事件A时，发生事 件B，请求CPU处理

中断处理：CPU暂停事件A的处理， 转而处理事件B

中断返回：事件B处理完毕，回到事件A被中断 的地方继续处理事件A

## 为什么要有中断

1. 速度匹配：解决快速CPU与慢速外设之间传送数据的矛盾。 
2. 分时操作：CPU可以分时为多个外设服务，提高效率。 
3.  实时响应：CPU能及时处理随机事件，增强系统实用性。 
4. 可靠性高：CPU可以处理设备故障等突发事件，提高系统可靠性。

## 中断的处理流程

主程序（后台）执行主程序

出现了中断请求

保存断点（当前指令执行完后下一条指令所在的地址）

进行中断响应，进入终端服务程序（前台）并执行具体任务

执行完后进行中断返回，回到断点继续执行主程序



# 串口通信

## 通信协议

通信协议是指双方实体完成通信或服务所必须遵循的规则和约定。协议定义了[数据单元](https://baike.baidu.com/item/数据单元)使用的格式，信息单元应该包含的信息与含义，连接方式，信息发送和接收的时序，从而确保网络中数据顺利地传送到确定的地方。

## 串口通信的物理层

1.通讯结构
串口通讯的物理层的主要标准是RS-232标准，其规定了信号的用途、通讯接口及信号的电平标准，其通讯结构如下：

![](c:\users\Jason\Pictures\20190730194334381.png)

在设备内部信号是以TTL电平标准传输的，设备之间是通过RS-232电平标准传输的，而且TTL电平需要经过电平转换芯片才能转化为RS-232电平，RS-232电平转TTL电平也是如此。
2.电平标准：在电子电路中常使用TTL的电平标准，但其抗干扰能力较弱，为了增加串口的通讯距离及抗干扰能力，使用RS-232电平标准在设备之间传输信息，经常使用MA3232芯片对TTL电平及RS-232电平进行相互转换。

## 串口通信的协议层

1.数据包
串口通讯的数据包由发送设备通过自身的TXD接口传输到接收设备得RXD接口，在协议层中规定了数据包的内容，具体包括起始位、主体数据（8位或9位）、校验位以及停止位，通讯的双方必须将数据包的格式约定一致才能正常收发数据。

2.波特率
由于异步通信中没有时钟信号，所以接收双方要约定好波特率，即每秒传输的码元个数，以便对信号进行解码，常见的波特率有4800、9600、115200等。STM32中波特率的设置通过串口初始化结构体来实现。
3.起始和停止信号
数据包的首尾分别是起始位和停止位，数据包的起始信号由一个逻辑0的数据位表示，停止位信号可由0.5、1、1.5、2个逻辑1的数据位表示，双方需约定一致。STM32中起始和停止信号的设置也是通过串口初始化结构体来实现。
4.有效数据
有效数据规定了主题数据的长度，一般为8或9位，其在STM32中也是通过串口初始化结构体来实现的。
5.数据校验
在有效数据之后，有一个可选的数据校验位。由于数据通信相对更容易受到外部干扰导致传输数据出现偏差，可以在传输过程加上校验位来解决这个问题。校验方法有奇校验(odd)、偶校验(even)、 0 校验(space)、 1 校验(mark)以及无(noparity)。这些也都可以在串口初始化结构体中实现的。

## 重要概念

校验位：一种简单的检错方式，又称奇偶校验位。如果是奇校验，需要保证传输的数据总共有奇数个逻辑高位；如果是偶校验，需要保证传输的数据总共有偶数个逻辑高位。

波特率：每秒钟传输的二进制数码的位数，以bit/s（bps）为单位，用于衡量通信速率快慢。由于异步通信中没有时钟信号，所以接收双方要约定好波特率，即每秒传输的码元个数，以便对信号进行解码

数据帧：所谓数据帧（Data frame），就是数据链路层的协议数据单元，它包括三部分：帧头，数据部分，帧尾。其中，帧头和帧尾包含一些必要的控制信息，比如同步信息、地址信息、差错控制信息等；数据部分则包含网络层传下来的数据，比如IP数据包，等等。
